{% extends "base.html" %}
{% block content %}
<h2 class="title">{{ t["welcome.capital.home"] }}</h2>
<div class="grid">
  <div class="widget">
    <h3>{{ t["widget.request_buff"] }}</h3>
    <p class="muted">{{ t["widget.request_buff.note"] }}</p>
    <form method="post" action="/buffs/create" id="buffForm" class="card">
      <label>Title</label>
      <select name="title" id="titleSel" required>
        {% for x in titles %}<option value="{{x}}">{{x}}</option>{% endfor %}
      </select>
      <label>Region</label>
      <select name="region" required>
        {% for r in regions %}<option value="{{r}}">{{r}}</option>{% endfor %}
      </select>
      <label>Date (UTC)</label>
      <input type="date" name="date" id="dateSel" required />
      <label>Hour (UTC)</label>
      <select name="hour_utc" id="hourSel" required>
        {% for h in range(0,24) %}{% set hh = "%02d"|format(h) %}
          <option value="{{hh}}">{{hh}}:00 - {{hh}}:59</option>
        {% endfor %}
      </select>
      <div id="conflictMsg" class="muted" style="display:none;">That slot is taken. Please choose another.</div>
      <button type="submit" id="submitBtn" class="btn-gold btn-inline">Submit</button>
    </form>
  </div>

  <div class="widget">
    <h3>{{ t["widget.view_buffs"] }}</h3>
    <p class="muted">{{ t["widget.view_buffs.note"] }} â€” <a href="/ical/two-days.ics">{{ t["btn.download_ics"] }}</a></p>
    {% if is_admin %}
    <form method="post" action="/admin/buffs/clear" onsubmit="return confirm('{{ t['admin.confirm_clear'] }}')" style="margin-bottom:8px">
      <button type="submit" class="btn-gold">{{ t["admin.clear_buffs"] }}</button>
    </form>
    {% endif %}
    <div id="buffList" class="card"></div>
    <div class="discord-link">
      <svg viewBox="0 0 245 240" width="16" height="16" style="width:16px;height:16px" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="#d4af37" d="M104.4 104.9c-5.7 0-10.2 5-10.2 11.1s4.6 11.1 10.2 11.1c5.7 0 10.2-5 10.2-11.1s-4.5-11.1-10.2-11.1zm36.2 0c-5.7 0-10.2 5-10.2 11.1s4.6 11.1 10.2 11.1c5.7 0 10.2-5 10.2-11.1s-4.5-11.1-10.2-11.1z"/><path fill="#d4af37" d="M189.5 20h-134C38.3 20 24 34.3 24 52.6v134.7C24 205.7 38.3 220 56.6 220h113.4l-5.3-18.6 12.8 11.9 12.1 11.2 21.5 19V52.6C211.1 34.3 196.8 20 178.5 20zm-38.3 135.4s-3.6-4.3-6.6-8.1c13.1-3.7 18.1-11.9 18.1-11.9-4.1 2.7-8 4.5-11.5 5.8-5 2.1-9.8 3.5-14.5 4.3-9.6 1.8-18.4 1.3-25.9-.1-5.7-1.1-10.6-2.5-14.6-4.3-2.3-.9-4.8-2-7.3-3.4-.3-.2-.6-.3-.9-.5-.2-.1-.3-.2-.4-.3-1.8-1-2.8-1.7-2.8-1.7s4.8 8 17.5 11.7c-3 3.8-6.7 8.3-6.7 8.3-22.2-.7-30.6-15.3-30.6-15.3 0-32.3 14.5-58.4 14.5-58.4 14.5-10.9 28.3-10.6 28.3-10.6l1 1.2c-18.2 5.2-26.6 13.1-26.6 13.1s2.2-1.2 5.9-2.9c10.7-4.7 19.2-6 22.7-6.3.6-.1 1.2-.2 1.8-.2 6.6-.9 14-1.2 21.8-.2 10.3 1.2 21.4 4.3 32.7 10.6 0 0-8-7.6-25.2-12.8l1.4-1.6s13.8-.3 28.3 10.6c0 0 14.5 26.1 14.5 58.4 0-.1-8.4 14.5-30.7 15.2z"/></svg>
      <a href="https://discord.gg/FfZz6SuXKb" target="_blank" rel="noopener">Join us on Discord</a>
    </div>
  </div>
</div>
<script>
const IS_ADMIN = {{ 'true' if is_admin else 'false' }};
function pad(n){ return n<10 ? "0"+n : ""+n; }

async function checkConflict(){
  const title = document.getElementById('titleSel').value;
  const date = document.getElementById('dateSel').value;
  const hour = document.getElementById('hourSel').value;
  const btn = document.getElementById('submitBtn');
  const msg = document.getElementById('conflictMsg');
  if(!title || !date || !hour){ msg.style.display='none'; btn.disabled=false; return; }
  const iso = date + "T" + hour + ":00:00+00:00";
  const res = await fetch(`/api/conflict?title=${encodeURIComponent(title)}&start_iso=${encodeURIComponent(iso)}`);
  const j = await res.json();
  if(j.conflict){ msg.style.display='block'; btn.disabled=true; } else { msg.style.display='none'; btn.disabled=false; }
}
['titleSel','dateSel','hourSel'].forEach(id=>document.getElementById(id).addEventListener('change', checkConflict));

async function renderList(){
  const box = document.getElementById('buffList');
  box.innerHTML = "{{ t['msg.loading'] }}";
  const r = await fetch('/api/list-two-days');
  const j = await r.json();
  if(!j.items.length){ box.innerHTML = "<p class='muted'>{{ t['msg.no_upcoming'] }}</p>"; return; }
  let html = "<table class='tbl'><tr><th>{{ t['th.utc_start'] }}</th><th>{{ t['th.title'] }}</th><th>{{ t['th.region'] }}</th><th>{{ t['th.user'] }}</th><th>{{ t['th.source'] }}</th><th>{{ t['th.actions'] }}</th></tr>";
  j.items.forEach(it=>{
    const dt = new Date(it.start_iso);
    const stamp = dt.getUTCFullYear()+"-"+pad(dt.getUTCMonth()+1)+"-"+pad(dt.getUTCDate())+" "+pad(dt.getUTCHours())+":00 UTC";
    const srcText = it.source==='discord' ? "Discord" : "Web";
    let actions = "";
    if(IS_ADMIN){
      if(it.id.startsWith("db:")){
        const dbid = it.id.split(":")[1];
        actions = `
          <div class="actions-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <form method="post" action="/admin/buffs/delete">
              <input type="hidden" name="src" value="db"/>
              <input type="hidden" name="id" value="db:${dbid}"/>
              <button type="submit" class="btn-gold btn-inline">{{ t['admin.delete'] }}</button>
            </form>
            <a class="btn-gold btn-inline" href="/buffs/edit/${dbid}" style="text-decoration:none; padding:6px 12px; border:1px solid #d4af37; border-radius:10px; background:#d4af37; color:#000;">{{ t['admin.edit'] }}</a>
          </div>`;
      } else {
        actions = `
          <div class="actions-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <form method="post" action="/admin/buffs/delete">
              <input type="hidden" name="src" value="discord"/>
              <input type="hidden" name="title" value="${it.title}"/>
              <input type="hidden" name="start_iso" value="${it.start_iso}"/>
              <button type="submit" class="btn-gold btn-inline">{{ t['admin.delete'] }}</button>
            </form>
          </div>`;
      }
    } else if(it.id.startsWith("db:")) {
      const dbid = it.id.split(":")[1];
      actions = `<div class="actions-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><a class="btn-gold btn-inline" href="/buffs/edit/${dbid}" style="text-decoration:none; padding:6px 12px; border:1px solid #d4af37; border-radius:10px; background:#d4af37; color:#000;">{{ t['admin.edit'] }}</a></div>`;
    }
    html += `<tr><td>${stamp}</td><td>${it.title}</td><td>${it.region}</td><td>${it.aoe_name}</td><td style="text-align:center">${srcText}</td><td class="actions-cell">${actions}</td></tr>`;
  });
  html += "</table>";
  box.innerHTML = html;
}
renderList();
setInterval(renderList, 60000);
</script>
{% endblock %}
